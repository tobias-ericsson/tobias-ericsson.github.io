<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Malmö Seawind</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
</head>
<body>
<div class="flex-container">
    <header>
        <h1>Malmö Seawind</h1>
        <h4>Wind forecast for sailors, wind and kite surfers in the Malmö region</h4>
    </header>

    <nav>
        <a href="http://www.weatherlink.com/user/lommahamn/index.php?view=summary&headers=0" >Current wind in Lomma</a>
        <a href="http://courel.se/kitesurf.html" >Wind in Lomma by Courel</a>
        <a href="http://www.dmi.dk/vejr/til-lands/byvejr/by/vis/SE/2694264/Lomma,Sverige" >Lomma by dmi.dk</a>
    </nav>

    <section>
        <h1>Lomma Beach</h1>

        <div class="wind-container" id='lomma'></div>
    </section>
    <section>
        <h1>Habo Ljung Beach</h1>

        <div class="wind-container" id='haboljung'></div>
    </section>
    <section>
        <h1>Ribban Beach</h1>

        <div class="wind-container" id='ribban'></div>
    </section>
    <section>
        <h1>Klagshamn</h1>

        <div class="wind-container" id='klagshamn'></div>
    </section>
    <footer>
        <h3>Tobias Ericsson</h3>
        <h4>Sailor, windsurfer, kitesurfer and father</h4>
    </footer>
</div>
<style scoped="">
    html {
        height: 100%;
    }

    body {
        margin: 0;
        padding: 0;
        color: #001f3f;
        height: 100%;
        font-size: 100%;
        min-width: 490px;
    }

    @media screen and (min-width: 700px) {
        body {
            background-color: lightgreen;
        }
        p {
            text-align: center;
            margin: 0 0 0 6px;
            min-width: 65px;
        }
    }

    @media screen and (max-width: 699px) {
        body {
            background-color: white;
        }
        p {
            text-align: center;
            margin: 0 0 0 6px;
            max-width: 40px;
        }
    }

    header, footer {
        text-align: center;
        color: green;
    }

    nav {
        text-align: center;
        color: green;
        padding: 10px;
        border-bottom: 0.5vh solid #001f3f;
        min-width: 490px;
    }

    p {
        font-size: 0.8em;
    }

    a {
        color: green;
        text-decoration: none;
        border: 1px solid #000000;
        padding: 4px;
    }

    a:visited {
        color: green;
    }

    /* mouse over link */
    a:hover {
        color: white;
        background-color: #001f3f;
    }

    /* selected link */
    a:active {
        color: blue;
    }

    footer {
        font-size: 60%;
    }

    footer > h3 {
        margin: 5px 0;
    }

    footer > h4 {
        margin: 2px 0 20px 0;
        padding: 0;
    }

    section {
        /* height: 240px; */
        padding: 2px 0 10px 0;
        border-bottom: 0.5vh solid #001f3f;
    }

    section > h1 {
        padding: 0.5vh;
        margin: 0 0 0 6px;
    }

    .flex-container {
        display: -webkit-flex; /* Safari */
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
        align-content: space-between;
        height: 100%;
    }

    .flex-container > section {
        flex: 1;
    }

    .wind-container {
        display: -webkit-flex; /* Safari */
        display: flex;
        flex-direction: row;
        justify-content: space-between;
        align-items: stretch;
        align-content: space-between;
        height: 100%;
    }
</style>
<script>
    var seawind = function () {
        var latLongs = [
            {name: 'lomma', lat: 55.680, long: 13.055},
            {name: 'haboljung', lat: 55.690, long: 13.051},
            {name: 'ribban', lat: 55.602, long: 12.956},
            {name: 'klagshamn', lat: 55.522, long: 12.889}
        ];

        var SMHI_URL = 'http://opendata-download-metfcst.smhi.se/api/category/pmp2g/version/2/geotype/point';

        var today = new Date();

        function log(message) {
            if (typeof console == "object") {
                console.log(arguments.callee.caller.name + " " + message);
            }
        }

        function get(url, id, successCallback) {
            log("ajax: " + url);
            $.ajax({
                type: "GET",
                dataType: "json",
                url: url,
                success: function (result) {
                    //log("ajax: " + JSON.stringify(result));
                    successCallback(id, result);
                },
                error: function (xhr, status, error) {
                    log("ajax error: " + status + " " + JSON.stringify(error));
                }
            });
        }

        var extractWeatherList = function (result) {
            var times = [];
            for (var k = 0; k < result.timeSeries.length-5; k = Math.floor(k * 1.05) + 2) {
                //log(k);
                var hour = result.timeSeries[k].validTime.slice(11, 13);
                if (hour>8 && hour<21) {
                    times.push(extractUsefulInfo(result, k));
                }
            }
            //log(times);
            return times;
        };

        var extractUsefulInfo = function (result, k) {
            function param(number) {
                return result.timeSeries[k].parameters[number].values[0];
            }

            var weather = {};
            weather.time = result.timeSeries[k].validTime;
            weather.windDirection = param(3);
            weather.windSpeed = param(4);
            weather.windGustSpeed = param(11);
            weather.symbol = param(18);
            return weather;
        };

        var addWeatherSectionsToDomElement = function (domId, weatherList) {
            log(domId);
            var place = document.getElementById(domId);
            var color = 'black';
            if (place) {
                var htmlText = '';
                var w;
                for (var k = 0; k < weatherList.length; k++) {
                    w = weatherList[k];
                    if (w.windSpeed>5 && w.windSpeed<11) {
                        color = 'green';
                    } else  if (w.windSpeed<4 || w.windSpeed>13) {
                        color = 'red';
                    } else {
                        color = 'black';
                    }

                    htmlText = htmlText + '<div><p style="color:'+color+'">' +
                    w.windSpeed.toFixed(1) + ' (' + w.windGustSpeed.toFixed(1) + ') m/s</p><p>' +
                    formatDirection(w.windDirection) + '&deg;</p><p>' +
                        //w.symbol + '</p><p>' +
                    formatDate(w.time) + '</p></div>';
                }
                place.innerHTML = htmlText;
            }
        };

        var formatDate = function (dateString) {
            var today = new Date();
            var date = new Date(dateString);
            var day = date.getDate();
            var month = date.getMonth() + 1;
            var time = dateString.slice(11, 16);

            if (day == today.getDate()) {
                return time;
            } else {
                return time + ' ' + day + '/' + month;
            }
        };

        var formatDirection = function (degrees) {
            var val=Math.floor((degrees/22.5)+.5);
            var arr=["N&nbsp;&nbsp;","NNE","NE","ENE","E&nbsp;&nbsp;","ESE", "SE", "SSE","S&nbsp;&nbsp;","SSW","SW","WSW","W&nbsp;&nbsp;","WNW","NW","NNW"];
            return arr[(val % 16)] + ' ' + degrees;
        };

        for (var k = 0; k < latLongs.length; k++) {
            get(SMHI_URL + '/lon/' + latLongs[k].long + '/lat/' + latLongs[k].lat + '/data.json', latLongs[k].name,
                    function (id, result) {
                        var weatherList = extractWeatherList(result);
                        addWeatherSectionsToDomElement(id, weatherList);
                    });
        }
    }();
</script>
</body>
</html>